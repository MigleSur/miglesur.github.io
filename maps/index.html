<!DOCTYPE html>
<meta charset="utf-8">
<style>

    .country.ESP { fill: #ddc; }
    .country.DEU { fill: #cdd; }
    .country.GBR { fill: #dcd; }
    .country.IRL { fill: white; }
    //.country.IRL { display: none; }

    .country-boundary.IRL {
        stroke: #aaa;
    }


    .country-boundary {
        fill: none;
        stroke: #777;
        stroke-dasharray: 2, 2;
        stroke-linejoin: round;


    .country-label {
        fill: #45771f;
        fill-opacity: .5;
        font-size: 20px;
        font-weight: 300;
        text-anchor: middle;
    }

    }




</style>
<body>
<!--<script src="scripts/require.js"></script>-->
<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script>

    var width = 960,
        height = 1160;

    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);


    function assign_color(gei_value) {
        colors = ["#EE4035", "#F3A530", "#56B949", "#30499B"];
        gei_fraction = gei_value / 25;
        color_index = Math.floor(gei_fraction);
        return colors[color_index];
    }

    var year = "2005";

    d3.csv("data/active_countries.csv", function(error1, active_countries) {
        if (error1) throw error1;

        d3.tsv("gei"+year+".tsv",

            function(d) {

            d["Overall"] = +d["Overall"];
            d["Work"] = +d["Work"];
            d["Money"] = +d["Money"];
            d["Knowledge"] = +d["Knowledge"];
            return d;

            },

            function(error2, gei) {
            if (error2) throw error2;

    console.log("active_countries");
    console.log(active_countries);
    console.log("gei");
    console.log(gei);


    d3.json("data/custom.json", function(error, custom) {
        if (error) return console.error(error);


        // svg.append("path")
        //     .datum(topojson.feature(custom, custom.objects.countries))
        //     .attr("d", d3.geo.path().projection(d3.geo.mercator()));


        // Base map

        var countries = topojson.feature(custom, custom.objects.countries);

        // Select projection
        // var projection = d3.geo.mercator()
        //     .scale(500)
        //     .translate([width / 2, height / 2]);

        var projection = d3.geo.albers()
            .center([0, 55.4])
            .rotate([4.4, 0])
            .parallels([35, 80])
            //.scale(6000)
            .translate([width / 2, height / 2]);

        var path = d3.geo.path()
            .projection(projection);

        svg.append("path")
            .datum(countries)
            .attr("d", path);


        svg.selectAll(".country")
            .data(topojson.feature(custom, custom.objects.countries).features)
            .enter().append("path")
            .attr("class", function(d) {
                // console.log(d.id);
                return "country " + d.id; })
            .style("fill", function(d) {
                // console.log(d);
                // console.log(d.id);
                for (i=0; i < gei.length; i++) {

                    if (gei[i]["Country"] === d.id) {
                        console.log(gei[i]["Country"]);
                        console.log(d.id);

                        return assign_color(gei[i]["Overall"]);
                    }
                }
                return "#c7ffff";
            })
            .attr("d", path);


        // Display boundaries

        svg.append("path")
            .datum(topojson.mesh(custom, custom.objects.countries))
            .datum(topojson.mesh(custom, custom.objects.countries, function(a, b) { return a !== b && active_countries.indexOf(a.id) >= 0; }))
            .attr("d", path)
            .attr("class", "country-boundary");



        // Displaying places
//        svg.append("path")
//            .datum(topojson.feature(custom, custom.objects.places))
//            .attr("d", path)
//            .attr("class", "place");
//
//        svg.selectAll(".place-label")
//            .data(topojson.feature(custom, custom.objects.places).features)
//            .enter().append("text")
//            .attr("class", "place-label")
//            .attr("transform", function(d) { return "translate(" + projection(d.geometry.coordinates) + ")"; })
//            .attr("dy", ".35em")
//            .text(function(d) { return d.properties.name; });
//
//        svg.selectAll(".place-label")
//            .attr("x", function(d) { return d.geometry.coordinates[0] > -1 ? 6 : -6; })
//            .style("text-anchor", function(d) { return d.geometry.coordinates[0] > -1 ? "start" : "end"; });


        // svg.selectAll(".country-label")
        //     .data(topojson.feature(custom, custom.objects.countries).features)
        //     .enter().append("text")
        //     .attr("class", function(d) { return "country-label " + d.id; })
        //     .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; })
        //     .attr("dy", ".35em")
        //     .text(function(d) { console.log(d); return d.id; });




    });
        });

    });

</script>
